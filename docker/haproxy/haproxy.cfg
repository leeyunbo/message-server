global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    retries 3
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# HAProxy Statistics
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 30s
    stats realm HAProxy\ Statistics
    stats auth admin:admin

# RabbitMQ AMQP Load Balancer (Round Robin)
listen rabbitmq_amqp
    bind *:5672
    mode tcp
    balance roundrobin
    option tcplog

    # Health check
    option tcp-check
    tcp-check connect

    # RabbitMQ Cluster Nodes
    server rabbitmq-1 rabbitmq-1:5672 check inter 5000 rise 2 fall 3
    server rabbitmq-2 rabbitmq-2:5672 check inter 5000 rise 2 fall 3
    server rabbitmq-3 rabbitmq-3:5672 check inter 5000 rise 2 fall 3

# RabbitMQ Management UI Load Balancer
listen rabbitmq_management
    bind *:15672
    mode http
    balance roundrobin
    option httplog

    # Health check (Management UI)
    option httpchk GET /api/health/checks/alarms
    http-check expect status 200

    # RabbitMQ Management UI Nodes
    server rabbitmq-1 rabbitmq-1:15672 check inter 5000 rise 2 fall 3
    server rabbitmq-2 rabbitmq-2:15672 check inter 5000 rise 2 fall 3
    server rabbitmq-3 rabbitmq-3:15672 check inter 5000 rise 2 fall 3
